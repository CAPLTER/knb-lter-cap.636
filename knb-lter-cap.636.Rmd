---
title: "capeml template"
author: "information manager"
date: Sys.Date()
output: html_document
editor_options: 
  chunk_output_type: console
---

# libraries

```{r libraries}
library(tidyverse)
library(capeml)
library(gioseml)
```

# micromet_data

```{r micromet-data, eval=TRUE, warning=FALSE}

micromet_data <- dbGetQuery(pg, "
  SELECT
    events.timestamp,
    sites.site_code,
    -- events.site_id,
    events.replicate,
    variables.variablecode,
    observations.reading
  FROM micromet.events
  JOIN micromet.observations ON (observations.event_id = events.id)
  JOIN micromet.variables ON (variables.id = observations.variable_id)
  JOIN micromet.sites ON (sites.id = events.site_id) ;
  ")

  micromet_data <- micromet_data %>%
    tidyr::pivot_wider(
      names_from = variablecode,
      values_from = reading
      ) %>%
  mutate(
    site_code = as.factor(site_code)
    ) %>%
  rlang::set_names(tolower(names(.)))

try({
  write_attributes(micromet_data)
  write_factors(micromet_data)
})

micromet_data_desc <- "Micrometeorological data from the CAP LTER weather stations located at the Desert Botanical Garden and Lost Dutchman State Park, AZ, USA sites. Data are 10-min averages of measurments collected at 5-second intervals."

micromet_data_DT <- create_dataTable(
  dfname = micromet_data,
  description = micromet_data_desc,
  dateRangeField = "timestamp"
)

```

# micromet_program_DBG

```{r micromet-program-DBG, eval=TRUE}

micromet_program_DBG_desc <- "data logger and sensor control program for Campbell data logger at the CAP LTER Desert Botanical Garden site"
micromet_program_DBG_additional <- "developed with Campbell Loggernet software"

micromet_program_DBG_OE <- create_otherEntity(
  target_file_or_directory = "tower_operation/CNDep_DBG_MetTower.CR1",
  description = micromet_program_DBG_desc,
  additional_information = micromet_program_DBG_additional
)

```

# micromet_program_LDP

```{r micromet-program-LDP, eval=TRUE}

micromet_program_LDP_desc <- "data logger and sensor control program for Campbell data logger at the CAP LTER Lost Dutchman Park site"
micromet_program_LDP_additional <- "developed with Campbell Loggernet software"

micromet_program_LDP_OE <- create_otherEntity(
  target_file_or_directory = "tower_operation/CNDep_LDP_MetTower.CR1",
  description = micromet_program_LDP_desc,
  additional_information = micromet_program_LDP_additional
)

```

# maintenance_log

```{r maintenance-log, eval=TRUE, error=TRUE}

maintenance_log <- read_csv("maintenance_log.csv") %>%
  rename(site_code = site) %>%
  mutate(site_code = as.factor(site_code))

try({
  write_attributes(maintenance_log, overwrite = FALSE)
  write_factors(maintenance_log, overwrite = FALSE)
})

maintenance_log_desc <- "log of maintenance activity, especially sensor calibration and replacement, at the CAP LTER micromet towers"

maintenance_log_DT <- create_dataTable(
  dfname = maintenance_log,
  description = maintenance_log_desc,
  dateRangeField = "date"
)

```


# people

See the gioseml package for examples of creating people resources from scratch.

```{r people}

# creator(s) - required

jonAllen <- create_role(
  firstName = "jon",
  lastName = "allen",
  roleType = "creator"
)

nancyGrimm <- create_role(
  firstName = "n",
  lastName = "grimm",
  roleType = "creator"
)

sharonHall <- create_role(
  firstName = "shar",
  lastName = "hall",
  roleType = "creator"
)

jasonKaye <- create_role(
  firstName = "jaso",
  lastName = "kaye",
  roleType = "creator"
)

creators <- list(
  nancyGrimm,
  sharonHall,
  jasonKaye,
  jonAllen
)

# metadata provider - required

stevanEarl <- create_role(
  firstName = "s",
  lastName = "earl",
  roleType = "metadata"
)

quincyStewart <- create_role(
  firstName = "q",
  lastName = "stewart",
  roleType = "metadata"
)

sallyWittlinger <- create_role(
  firstName = "s",
  lastName = "wittlinger",
  roleType = "metadata"
)

kristinGodbeer <- create_role(
  firstName = "k",
  lastName = "godbeer",
  roleType = "metadata"
)

metadataProvider <- list(
  stevanEarl,
  quincyStewart,
  sallyWittlinger,
  kristinGodbeer
)

```


# keywords

```{r keywords}

write_keywords()
```


# methods

Methods are automatically read from a `methods.md` file in the project
directory. If more elaborate methods are required, e.g., to incorporate
provenance, use the enhancedMethods approach.


# coverages

```{r coverages}

# LDP geographic

ldp_coords <- EML::eml$boundingCoordinates(
  westBoundingCoordinate = "-111.4795",
  eastBoundingCoordinate = "-111.4789",
  northBoundingCoordinate = "33.4626",
  southBoundingCoordinate = "33.4622"
)

ldp_geo <- EML::eml$geographicCoverage(
  geographicDescription = "CAP LTER site at Lost Dutchman State Park, AZ, USA",
  boundingCoordinates = ldp_coords,
  id = "geographicCoverage.LDP"
)

# DGB geographic

dbg_coords <- EML::eml$boundingCoordinates(
  westBoundingCoordinate = "-111.9476",
  eastBoundingCoordinate = "-111.9415",
  northBoundingCoordinate = "33.4612",
  southBoundingCoordinate = "33.4554"
)

# geographic

dbg_geo <- EML::eml$geographicCoverage(
  geographicDescription = "CAP LTER site at the Desert Botanical Garden, AZ, USA",
  boundingCoordinates = dbg_coords,
  id = "geographicCoverage.DBG"
)

# temporal

end_date <- dbGetQuery(pg, "SELECT MAX(timestamp) FROM micromet.events ; ")
end_date <- as.character(end_date, format = "%Y-%m-%d")

tower_begin <- EML::eml$beginDate(calendarDate = "2006-05-10")
tower_end <- EML::eml$endDate(calendarDate = end_date)

tower_range <- EML::eml$rangeOfDates(
  beginDate = tower_begin,
  endDate = tower_end
)
tower_temporal <- EML::eml$temporalCoverage(rangeOfDates = tower_range)

# coverage
coverage <- EML::eml$coverage(
  geographicCoverage = list(
    ldp_geo,
    dbg_geo),
  temporalCoverage = tower_temporal
)

```

# custom units

```{r custom-units, eval=TRUE}

custom_units <- rbind(
  data.frame(
    id = "kilowattPerMeterSquared",
    unitType = "irradiance",
    parentSI = "wattPerMeterSquared",
    multiplierToSI = "1000",
    description = "average amount of energy per square meter of surface during the observation period"
    ),
  data.frame(
    id = "megajoulePerMeterSquared",
    parentSI = "joulePerMeterSquared",
    unitType = "irradiance",
    multiplierToSI = "1000000",
    description = "total amount of energy per square meter of surface during the observation period")
)

unitList <- EML::set_unitList(
  custom_units,
  as_metadata = TRUE
)

```


# dataset

Optionally, provide: scope, abstract, methods, keywords, publication date.
Projects scopes include lter (default), gios, urex, ltreb, and som.

```{r construct-dataset}

dataset <- create_dataset()
```


# add dataTable

```{r dataSet$dataTable}

# add dataTables if relevant

print(ls(pattern = "_DT"))

if (length(ls(pattern = "_DT")) > 0) {

  listOfDataTables <- lapply(ls(pattern = "_DT"), function(DT) { get(DT) } )

  dataset$dataTable  <- listOfDataTables

}

# or add manually
# dataset$dataTable <- list(dataTableOne, dataTableTwo)
```


# add otherEntity

```{r dataSet$otherEntity}

# add other entities if relevant

print(ls(pattern = "_OE"))

if (length(ls(pattern = "_OE")) > 0) {

  listOfOtherEntities <- lapply(ls(pattern = "_OE"), function(OE) { get(OE) } )

  dataset$otherEntity <- listOfOtherEntities

}

# or add manually
# dataset$otherEntity <- list(otherEntityOne, otherEntityTwo)
```

# eml

```{r construct-eml, eval=TRUE}

eml <- capeml::create_eml()
```

```{r validate-eml, eval=TRUE}

EML::eml_validate(eml)
```

```{r eml-to-file, eval=TRUE}

capeml::write_cap_eml()
```

# file placement

## package details

```{r package-details, eval=TRUE}

# retrieve package details from config.yaml

if (!file.exists("config.yaml")) {
  stop("config.yaml not found")
}
packageIdent <- yaml::yaml.load_file("config.yaml")$packageIdent
packageNum <- yaml::yaml.load_file("config.yaml")$packageNum
```

## AWS settings

```{r S3_helper_functions}

# functions and setting for uploading to S3

library(aws.s3)
source("~/Documents/localSettings/aws.s3")
```

## upload data files

```{r preview_data_file_to_upload}

# preview data set files that will be uploaded to S3
list.files(pattern = paste0(packageNum, "_"), recursive = TRUE)
```

```{r upload_data_S3}

# upload files to S3

lapply(list.files(pattern = paste0(packageNum, "_"), recursive = TRUE), data_to_amz)
```

## copy and move XML as needed

```{r duplicate_xml_as_needed}

# XML to S3
eml_to_amz(list.files(pattern = paste0(packageIdent, ".xml")))

# XML to cap-data-eml
file.copy(
  from = list.files(pattern = paste0(packageIdent, ".xml")),
  to = "/home/srearl/localRepos/cap-metadata/cap-data-eml/"
)
```

## optionally delete data and xml files

```{r optional: preview_files_to_delete}

# preview files to delete
dir(pattern = paste0(packageNum, "_"), recursive = TRUE)
list.files(pattern = paste0(packageIdent, ".xml"), recursive = TRUE)
```

```{r optional: delete_files}

# delete files
file.remove(dir(pattern = paste0(packageNum, "_"), recursive = TRUE))
file.remove(list.files(pattern = paste0(packageIdent, ".xml")), recursive = TRUE)
```
